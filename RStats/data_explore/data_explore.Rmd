---
title: "Fully Deployed Front to Back End Fantasy Projection Model in R"
author: "Duncan Gates"
navlink: "[More Data Stuff](http://duncangates.me/)"
og:
  type: "article"
  title: "opengraph title"
  url: "optional opengraph url"
  image: "optional opengraph image link"
footer:
  - content: '[Shiny Apps](http://shinyapps.duncangates.me/) • [Github](http://www.github.com/dungates/)<br/>'
  - content: 'Copyright © Duncan Gates, 2021'
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: DGThemes::skeleton
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
library(tidyverse)
library(tidymodels)
library(DGThemes)
theme_set(theme_duncan())
df <- readr::read_csv(here::here("Data/player_season_totals.csv"))
```

## Introduction

#### Getting the Data

In order to predict the fantasy scores of NBA players in the 2021-2022 season I pulled data from basketball reference using `nbastatR`, grabbing the last 20 years of season totals from players, in both normal and advanced stats, which can conveniently be done with just one line of code!

```{r eval = F, echo = T}
df <- nbastatR::bref_players_stats(seasons = 2000:2021, tables = c("totals", "advanced"))
```

The only initial data manipulation is to create the response variable for the dataset, the fantasy points, which is done with a very simple formula in my league, the coefficients are arbitrarily chosen and lead to some interesting weighting in our modelling later on.

```{r eval = F, echo = T}
coefs <- tibble::tibble(ptsTotals = 1,
                        trbTotals = 1.2,
                        astTotals = 1.5,
                        stlTotals = 3,
                        blkTotals = 3,
                        tovTotals = -1,
                        fg3mTotals = 1)
```

#### Setting up the Database

The data we have is tabular, and can easily be setup an id which I did by adding a column that is just the season and player name pasted together in the format below

```{r eval = T, echo = F}
df %>%
  mutate(id = factor(stringr::str_replace_all(paste0(stringr::str_to_lower(yearSeason), "_", stringr::str_to_lower(namePlayer)), " ", ""))) %>%
  select(id) %>%
  slice_sample(n = 10)
```

This data lends itself quite easily to an SQLite relational database which I setup with `RSQLite`. First I save the data as a csv in the data folder, and then I establish a local connection and write the table to the database file. In this case I set `overwrite = TRUE` since I have written to the db before and am just saving it again, but it is generally unnecessary.

```{r}
readr::write_csv(df, "Data/player_season_totals.csv")

con <- DBI::dbConnect(RSQLite::SQLite(), dbname = "nba.db")

upload_data <- readr::read_csv("Data/player_season_totals.csv")

RSQLite::dbWriteTable(conn = con, 
                      name = "player_seasons", 
                      value = upload_data, 
                      overwrite = TRUE)
```

#### Regular Updates

Now to add data to the table regularly given the oncoming 2021-2022 season I add to the table regularly by running the following script on the server I hosted the data on.

```{r}
new_df <- nbastatR::bref_players_stats(2022, tables = "totals")
readr::write_csv(new_df, "Data/latest_season.csv")
```

## Analysis

```{r}

```
